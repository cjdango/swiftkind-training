{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Board detail{% endblock title %}

{% block content %}
    <div class="lists">
        <div class="form-group form-inline">            
            <input type="email" class="form-control mr-2" name="invite_email" placeholder="Enter email to invite" onkeypress="inviteUser(event, {{board.pk}})" />
            <button class="btn btn-primary form-control">Invite</button>
        </div>
        
        <ul class="list_list">
            <li class="list card bg-info text-white m-1 align-self-start">
                <form class="card-body text-center" method="post">
                    {% csrf_token %}
                    {{ form|crispy }}
                    <input class="btn btn-success border border-white" type="submit" value="Add list" />
                </form>
            </li>
            {% for list in board.list_set.all %}
                <li class="list card bg-info text-white m-1 align-self-start">
                    
                    <div class="card-header d-flex align-items-center justify-content-between">
                        {{list.title}}
                        <button class="btn btn-danger btn-sm" onclick="deleteList({{list.pk}})">X</button>
                    </div>
                    <ul class="card_list card-body text-dark">
                        {% for card in list.card_set.all %}
                            <li class="card mb-2">
                                <div class="card-body d-flex align-items-center justify-content-between">
                                    {{card.title}}
                                    <button class="btn btn-link text-danger p-0" onclick="deleteCard({{list.pk}}, {{card.pk}})">X</button>
                                </div>
                            </li>
                        {% endfor %}
                        <li class="card form-group mb-0">
                            <input type="text" class="form-control" placeholder="Add card" onkeypress="addCard(event, {{list.pk}})" />
                        </li>
                    </ul>

                </li>
            {% endfor %}
        </ul>
    </div>    
{% endblock content %}

{% block app_script %}
    <script>
        function inviteUser(e) {
            var email = e.target.value
            if (e.keyCode === 13) {
                $.ajax({
                    type: 'POST',
                    url: 'invites/new/',
                    data: { to: email },  
                    contentType: 'application/json',
                    success: function (data, textStatus, xhr) {  
                        // window.location.href = data.redirect
                        console.log(data)
                    },  
                    error: function (xhr, textStatus, errorThrown) {  
                        console.log('Error in Operation');  
                    }  
                });
            }
        }

        function deleteList(listPK) {
            $.ajax({
                type: 'DELETE',
                data: { pk: listPK },  
                contentType: 'application/json',
                success: function (data, textStatus, xhr) {  
                    window.location.href = data.redirect
                },  
                error: function (xhr, textStatus, errorThrown) {  
                    console.log('Error in Operation');  
                }  
            });
        }

        function deleteCard(listPK, cardPK) {
            $.ajax({
                type: 'DELETE',
                url: 'lists/' + listPK + '/cards/',
                data: { pk: cardPK },  
                contentType: 'application/json',
                success: function (data, textStatus, xhr) {  
                    window.location.href = data.redirect
                },  
                error: function (xhr, textStatus, errorThrown) {  
                    console.log('Error in Operation');  
                }  
            });
        }

        function addCard(e, listPK) {
            var cardTitle = e.target.value
            if (e.keyCode === 13) {
                $.ajax({
                    type: 'POST',
                    url: 'lists/' + listPK + '/cards/',
                    data: { title: cardTitle },  
                    contentType: 'application/json',
                    success: function (data, textStatus, xhr) {  
                        window.location.href = data.redirect
                    },  
                    error: function (xhr, textStatus, errorThrown) {  
                        console.log('Error in Operation');  
                    }  
                });
            }
        }
    </script> 
{% endblock app_script %}
